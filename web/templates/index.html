<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="apple-mobile-web-app-capable" content="yes" />

  <title>e</title>
  <link rel="manifest" href="/manifest.json" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
</head>
<body>	 
	<form id="myform" action="/register" method="post" onSubmit="subscribe()">
	<div class="mb-3">
		    <label for="exampleFormControlInput1" class="form-label">Target URL</label>
		    <input type="url" class="form-control" name="targetURL" id="exampleFormControlInput1" placeholder=""></input>
	</div>
	<div class="mb-3">
		    <label for="exampleFormControlTextarea1" class="form-label">Keywords</label>
		    <textarea class="form-control" name="keywords"  id="exampleFormControlTextarea1" rows="1" placeholder=""></textarea>
	</div>
	<button type="submit" class="btn btn-primary">Submit</button>
	</form>
<script>
       navigator.serviceWorker.ready
        .then(function(registration) {
          const vapidPublicKey = '발급한 vapidPublicKey 값으로 넣어주세요.';

            registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(vapidPublicKey),
          });
        })
        .then(function(subscription) {
	  localStorage.subscription = JSON.stringify(subscription)
          var form  = document.getElementById('myform');                
          var input = document.createElement("input");
          input.type = "hidden";
          input.name = "subscription"; // 서버에서 받을 파라미터 이름
          input.value = localStorage.subscription
          form.appendChild(input);
	  console.log(
            JSON.stringify({
              subscription: subscription,
            })
          );
        })
        .catch(err => console.error(err));


    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - (base64String.length % 4)) % 4);
      const base64 = (base64String + padding)
        .replace(/\-/g, '+')
        .replace(/_/g, '/');
      const rawData = window.atob(base64);
      return Uint8Array.from([...rawData].map(char => char.charCodeAt(0)));
    }

    function subscribe() {
// 푸시 알림 권한 요청
      if ('Notification' in window) {
	  Notification.requestPermission().then(permission => {
	         if (permission === "granted") {
	 	        //alert("푸시 알림 권한이 허용되었습니다.");
		 } else {
		        alert("푸시 알림 권한이 거부되었습니다." + permission);
		}
	});
      }
    }
    	if ('serviceWorker' in navigator) {
	    navigator.serviceWorker.register('/service-worker.js')
	    .then(function(registration) {
	           //alert('서비스 워커 등록 성공:', registration);
	    })
	   .catch(function(error) {
		   ///alert('서비스 워커 등록 실패:', error);
	    });
      navigator.serviceWorker.ready
        .then(function(registration) {
          return registration.pushManager.getSubscription();
        })
        .then(function(subscription) {
          if (!subscription) {
            subscribe();
          } else {
	    localStorage.subscription = JSON.stringify(subscription)			 
	    var form  = document.getElementById('myform');		  
            var input = document.createElement("input");
            input.type = "hidden";
            input.name = "subscription"; // 서버에서 받을 파라미터 이름
	    input.value = localStorage.subscription
	    var element = form.querySelector(`[name="subscription"]`);
	    if (element) {
		    form.removeChild(element);
	    }
            form.appendChild(input);		  
          }
        });
    }
  </script>
</body>
</html>
